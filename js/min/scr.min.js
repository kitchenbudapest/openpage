var g=g||{};(function(){"use strict";function colorToHex(components){var cmp,hex="#";for(var i=0;i<components.length;i++){cmp=components[i].toString(16);hex+=cmp.length===1?"0"+cmp:cmp}return hex}function Screen(args){this._zoom=1;this._span=1;this._fontTight=new args.fontFace({fillColor:args.foregroundColor,charSpan:1,charZoom:2});this._fontLoose=new args.fontFace({fillColor:args.foregroundColor,charSpan:2,charZoom:2});this._context=args.canvas.getContext("2d");this._fontFace=this._fontLoose;this._screenWidth=args.screenWidth;this._screenHeight=args.screenHeight;this._hOffset=args.horizontalOffset;this._vOffset=args.verticalOffset;this._fgColor=args.foregroundColor;this._fgGlow=colorToHex(args.foregroundGlowColor);this._fgGlowRadius=args.foregroundGlowRadius;this._postProcess=args.postProcessor;this.reset();var width=(this._screenWidth+this._hOffset*2)*this._fontFace.zoomedCharWidth,height=(this._screenHeight+this._vOffset*2)*this._fontFace.zoomedCharHeight,centerX=width*.5,centerY=height*.85,radius=Math.max(centerX,centerY)*1.6,gradient=this._context.createRadialGradient(centerX,centerY,0,centerX,centerY,radius);gradient.addColorStop(0,args.backgroundColor0);gradient.addColorStop(1,args.backgroundColor1);this._bgColor=gradient;args.canvas.width=width;args.canvas.height=height;this.printables=args.fontFace.printables;this.width=width;this.height=height}Screen.prototype.reset=function(){this._rowIndex=0;this._colIndex=0;this._buffer=[""];this._isBufferChanged=true};Screen.prototype.setZoom=function(value){if(value===1){this._zoom=2;this._fontFace.setCharZoom(1)}else if(value===2){this._zoom=1;this._fontFace.setCharZoom(2)}else return;this.reset()};Screen.prototype.setSpan=function(value){if(value){this._span=1;this._fontFace=this._fontLoose}else{this._span=2;this._fontFace=this._fontTight}this._fontFace.setCharZoom(this._zoom===1?2:1);this.reset()};Screen.prototype.newLine=function(){this._colIndex=0;this._buffer.push("");if(this._rowIndex+1<this._screenHeight*this._zoom*this._span)this._rowIndex++;else this._buffer.shift();this._isBufferChanged=true};Screen.prototype.write=function(text){var i=0,line,length,textLength=text.length,buffer=this._buffer,colIndex=this._colIndex,rowIndex=this._rowIndex,screenWidth=this._screenWidth*this._zoom,screenHeight=this._screenHeight*this._zoom*this._span,colLeft=screenWidth-colIndex;do{line=text.slice(i,colLeft);length=line.length;if(!length)break;if(buffer[rowIndex]===undefined)buffer[rowIndex]="";buffer[rowIndex]+=line;i+=length;colLeft+=length;colIndex+=length;if(colIndex>=screenWidth){if(rowIndex+1<screenHeight)rowIndex++;else buffer.shift();colIndex=0}}while(i<textLength);this._rowIndex=rowIndex;this._colIndex=colIndex;this._isBufferChanged=true};Screen.prototype.popChar=function(count){if(!count)return;var lineCount=Math.floor(count/(this._screenWidth*this._zoom)),charCount=count%(this._screenWidth*this._zoom);if(lineCount)this.popLine(lineCount);var line=this._buffer[this._rowIndex];if(line!==undefined){line=line.slice(0,line.length-charCount);if(line.length)this._buffer[this._rowIndex]=line;else if(this._buffer.length>1){this._buffer.pop();--this._rowIndex}}this._isBufferChanged=Boolean(lineCount||line)};Screen.prototype.popLine=function(count){if(!count)return;this._buffer=this._buffer.slice(0,-count);this._rowIndex=this._buffer.length?this._buffer.length-1:0;this._isBufferChanged=true};Screen.prototype._prepareContext=function(context){context.fillStyle=this._bgColor;context.fillRect(0,0,this.width,this.height);context.shadowBlur=this._fgGlowRadius;context.shadowColor=this._fgGlow};Screen.prototype.render=function(){if(this._isBufferChanged){var i,j,row,line,hOff=this._hOffset,vOff=this._vOffset,rowIndex=this._rowIndex,buffer=this._buffer,context=this._context,fontFace=this._fontFace,chrW=fontFace.zoomedCharWidth,chrH=fontFace.zoomedCharHeight,scrW=this._screenWidth*this._zoom,scrH=this._screenHeight*this._zoom*this._span;this._prepareContext(context);for(i=0;i<buffer.length;i++){line=buffer[i];row=(i+vOff)*chrH;for(j=0;j<line.length;j++)fontFace.renderCharAt(line[j],context,(j+hOff)*chrW,row)}fontFace.renderCharAt("block",context,(j+hOff)*chrW,row);if(this._postProcess){context.putImageData(this._postProcess(context.getImageData(0,0,this.width,this.height),context.createImageData(this.width,this.height),this.width,this.height),0,0)}this._isBufferChanged=false}};g.scr={Screen:Screen}})();