var g=g||{};(function(){"use strict";var PRINTABLES=g.font.VT220.printables;function Shell(frame,context,distort){this._INTRO=["  ##########","  ##      ##  KITCHEN","  ##      ##  BUDAPEST","  ##      ##  Powered by *T**","  ##########",""];this._PS1="[visitor@kibu ~] $ ";this._index=0;this._history=[""];this._frame=frame;this._scr=new g.scr.Screen({context:context,fontFace:g.font.VT220,screenWidth:41,screenHeight:10,horizontalOffset:1.5,verticalOffset:.85,backgroundColor0:"#303030",backgroundColor1:"#080808",foregroundColor:[194,255,206],foregroundGlowColor:[154,254,174],foregroundGlowRadius:3,postProcessor:distort});this._std={io:{setReader:function(reader){this._readerHistory="";this._reader=reader}.bind(this),clear:this._scr.reset.bind(this._scr),write:this._scr.write.bind(this._scr),writeLine:function(text){this._scr.write(text);this._scr.newLine()}.bind(this)},lib:{yesOrNo:function(input){switch(input){case"":case"y":case"Y":case"yes":case"Yes":case"YES":return true;case"n":case"N":case"no":case"No":case"NO":return false;default:this._scr.write("Invalid input: "+input);this._scr.newLine();return null}}.bind(this),invalidArg:function(command,option){this._scr.write(command+": unrecognized option '"+(option||"")+"'");this._scr.newLine();this._scr.write("Try 'man "+command+"' for more information");this._scr.newLine()}.bind(this),openPopUp:function(url){var urlOpener=function(){window.open(url);this._frame.removeEventListener("click",urlOpener,false);this._urlOpener=undefined};if(this._urlOpener)this._frame.removeEventListener("click",this._urlOpener,false);this._frame.addEventListener("click",urlOpener,false);this._urlOpener=urlOpener;this._scr.newLine();this._scr.write("==> CLICK HERE TO OPEN LINK!");this._scr.newLine();this._scr.newLine()}.bind(this)}};var name="clear",desc="clear the terminal screen";g.install(name,{main:this._scr.reset.bind(this._scr),desc:desc,man:function(){this._scr.write(name);this._scr.newLine();this._scr.write("  "+desc);this._scr.newLine()}.bind(this)},["del","clean","reset"]);name="reboot";desc="reboot the machine";g.install(name,{main:this._poweroff.bind(this),desc:desc,man:function(){this._scr.write(name);this._scr.newLine();this._scr.write("  "+desc);this._scr.newLine()}.bind(this)},["kill","halt","reset","poweroff","shutdown"],true);this._resetAndWriteMultiLine(this._INTRO);this._scr.write(this._PS1);this._scr.render()}Shell.prototype.onKeyDown=function(event){var line;switch(event.which||event.keyCode){case g.kb.code.Return:this._scr.newLine();if(this._reader){if(!this._reader(this._std,this._readerHistory)){this._reader=undefined;this._scr.write(this._PS1)}this._readerHistory=""}else{this._execute(this._history[this._index++]);this._history[this._index]=""}break;case g.kb.code.BackSpace:if(this._reader)this._readerHistory=this._popCharFrom(this._readerHistory);else this._history[this._index]=this._popCharFrom(this._history[this._index]);break;case g.kb.code.Up:if(!this._reader)this._moveInHistory(-1);break;case g.kb.code.Down:if(!this._reader)this._moveInHistory(+1);break;default:return}this._scr.render();event.preventDefault()};Shell.prototype._moveInHistory=function(steps){var line=this._history[this._index+steps];if(line!==undefined){console.log(this._history[this._index],this._history[this._index].length);this._scr.popChar(this._history[this._index].length);this._scr.write(line);this._index+=steps}};Shell.prototype._popCharFrom=function(line){if(line.length){this._scr.popChar(1);line=line.slice(0,line.length-1)}return line};Shell.prototype.run=function(element){if(element.addEventListener){element.addEventListener("keydown",this.onKeyDown.bind(this),false);element.addEventListener("keypress",this.onKeyPress.bind(this),false)}else{element.attachEvent("onkeydown",this.onKeyDown.bind(this));element.attachEvent("onkeypress",this.onKeyPress.bind(this))}};Shell.prototype.onKeyPress=function(event){var scr=this._scr,char=String.fromCharCode(event.which||event.keyCode);if(!(event.ctrlKey||event.altKey||event.metaKey))event.preventDefault();if(PRINTABLES.indexOf(char)===-1)return;if(this._reader)this._readerHistory+=char;else this._history[this._index]+=char;scr.write(char);scr.render()};Shell.prototype._resetAndWriteMultiLine=function(msg){var scr=this._scr;scr.reset();for(var i=0;i<msg.length;i++){scr.write(msg[i]);scr.newLine()}};Shell.prototype._poweroff=function(argv){var scr=this._scr;scr.write("VT100 is rebooting now...");scr.newLine();scr.write("See you on the other side!");this._index=0;this._history=[""];if(this._urlOpener)this._frame.removeEventListener("click",this._urlOpener,false);this._resetAndWriteMultiLine(this._INTRO)};Shell.prototype._execute=function(input){var program,argv=input.split(" "),command=argv[0];argv.shift();if(command){program=g.bin(command).main;if(program instanceof Function)program(this._std,argv);else{this._scr.write("shell: "+command+": command not found");this._scr.newLine()}}if(!this._reader){this._scr.write(this._PS1);this._scr.render()}};g.shell={Shell:Shell}})();