var g=g||{};(function(){"use strict";function colorToHex(components){var cmp,hex="#";for(var i=0;i<components.length;i++){cmp=components[i].toString(16);hex+=cmp.length===1?"0"+cmp:cmp}return hex}function Screen(args){this._context=args.context;this._fontFace=args.fontFace;this._charWidth=args.charWidth;this._charHeight=args.charHeight;this._screenWidth=args.screenWidth;this._screenHeight=args.screenHeight;this._hOffset=args.horizontalOffset;this._vOffset=args.verticalOffset;this._fgColor=args.foregroundColor;this._fgGlow=colorToHex(args.foregroundGlowColor);this._fgGlowRadius=args.foregroundGlowRadius;this._postProcess=args.postProcessor;this.reset();var width=(args.screenWidth+args.horizontalOffset*2)*args.charWidth,height=(args.screenHeight+args.verticalOffset*2)*args.charHeight,centerX=width/2,centerY=height/2,radius=Math.max(centerX,centerY)*1.6,gradient=args.context.createRadialGradient(centerX,centerY,0,centerX,centerY,radius);gradient.addColorStop(0,args.backgroundColor0);gradient.addColorStop(1,args.backgroundColor1);this._width=width;this._height=height;this._bgColor=gradient}Screen.prototype.reset=function(){this._rowIndex=0;this._colIndex=0;this._buffer=[""];this._isBufferChanged=true};Screen.prototype.newLine=function(){this._colIndex=0;this._buffer.push("");if(this._rowIndex>=this._screenHeight)this._buffer.shift();else this._rowIndex++;this._isBufferChanged=true};Screen.prototype.write=function(text){var i=0,line,colLeft,buffer=this._buffer,colIndex=this._colIndex,rowIndex=this._rowIndex,screenWidth=this._screenWidth,screenHeight=this._screenHeight;do{colLeft=screenWidth-colIndex;if(buffer[rowIndex]===undefined)buffer[rowIndex]="";line=text.slice(i,colLeft);if(!line)break;buffer[rowIndex]+=line;i+=colLeft;colIndex+=line.length;if(colIndex>=screenWidth){if(rowIndex>=screenHeight)buffer.shift();else rowIndex++;colIndex=0}}while(i<text.length);this._rowIndex=rowIndex;this._colIndex=colIndex;this._isBufferChanged=true};Screen.prototype.popChar=function(count){var line,lineCount=Math.floor(count/this._screenWidth),charCount=count%this._screenWidth;if(lineCount)this.popLine(lineCount);line=this._buffer[this._rowIndex];if(line!==undefined){line=line.slice(0,line.length-charCount);if(!line&&this._buffer.length>1){this._buffer.pop();--this._rowIndex}else this._buffer[this._rowIndex]=line}this._isBufferChanged=true};Screen.prototype.popLine=function(count){this._buffer=this._buffer.slice(0,-count);this._rowIndex=this._buffer.length?this._buffer.length-1:0;this._isBufferChanged=true};Screen.prototype._prepareContext=function(context){context.fillStyle=this._bgColor;context.fillRect(0,0,this._width,this._height);context.shadowBlur=this._fgGlowRadius;context.shadowColor=this._fgGlow};Screen.prototype.render=function(){if(this._isBufferChanged){var i,j,row,line,rowIndex=this._rowIndex,hOff=this._hOffset,vOff=this._vOffset,chrW=this._charWidth,chrH=this._charHeight,scrW=this._screenWidth,scrH=this._screenHeight,buffer=this._buffer,context=this._context,fontFace=this._fontFace;this._prepareContext(context);for(i=0;i<buffer.length;i++){line=buffer[i];row=(i+vOff)*chrH;for(j=0;j<line.length;j++)fontFace.renderCharAt(line[j],context,(j+hOff)*chrW,row)}fontFace.renderCharAt("block",context,(j+hOff)*chrW,row);if(this._postProcess)this._postProcess();this._isBufferChanged=false}};g.scr={Screen:Screen}})();